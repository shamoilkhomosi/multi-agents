function dzdt = maspde4(t, z, x, phiL, phiR, k, h, Nh, mu, a)

Na = 5; % number of agents (make sure its divisible by Nh)
xsect = zeros(Na, Nh/Na);
for i=1:Na
    xsect(i,:) = x((i-1)*Nh/Na+1:(i)*Nh/Na);
end
z_soh = z;

dzdt = zeros(Nh, 1);
% define the boundary conditions
z(1) = phiL*(1-exp(-5*t));
z(Nh+1) = phiR*(1-exp(-5*t));
% dzdx   = zeros(Nh, 1);
% d2zdx2 = zeros(Nh, 1);

for i=1:Na
    i_global = (i-1)*Nh/Na+1:(i)*Nh/Na;
    x_lead = round(xsect(i,round(Nh/Na/2))/h)+1;
    z_lead = z(x_lead);
    
    if i > 2
        x_lead_ll = round(xsect(i-2,round(Nh/Na/2))/h)+1;
        z_lead_ll = z(x_lead_ll);
    else 
        x_lead_ll = 1;  % + 1 to have distinct X values for interp
        z_lead_ll = z(x_lead_ll);
    end

    if i > 1
        x_lead_l = round(xsect(i-1,round(Nh/Na/2))/h)+1;
        z_lead_l = z(x_lead_l);
    else
        x_lead_l = 1;
        z_lead_l = z(1);
    end

    if i < Na-1
        x_lead_rr = round(xsect(i+2,round(Nh/Na/2))/h)+1;
        z_lead_rr = z(x_lead_rr);
    else
        x_lead_rr = Nh+1;  % - 2 to have distinct X values for interp
        z_lead_rr = z(x_lead_rr);
    end
    
    if i < Na
        x_lead_r = round(xsect(i+1,round(Nh/Na/2))/h)+1;
        z_lead_r = z(x_lead_r);
    else
        x_lead_r = Nh+1;
        z_lead_r = z(x_lead_r);
    end
        
    for j=(i-1)*Nh/Na+1:x_lead
%         coeff = polyfit([x_lead_ll, x_lead_l, x_lead], [z_lead_ll, z_lead_l, z_lead], 2);
%         z_soh(j) = polyval(coeff, j);

        L0 = ((j-x_lead_l)*(j-x_lead_ll))/((x_lead-x_lead_l)*(x_lead-x_lead_ll))*z_lead;
        L1 = ((j-x_lead)*(j-x_lead_ll))/((x_lead_l-x_lead)*(x_lead_l-x_lead_ll))*z_lead_l;
        L2 = ((j-x_lead)*(j-x_lead_l))/((x_lead_ll-x_lead)*(x_lead_ll-x_lead_l))*z_lead_ll;
        L0 = L0*isnan(L0))
        z_soh(j) = L0+L1+L2;
    end

    for j=x_lead+1:(i)*Nh/Na
%         coeff = polyfit([x_lead, x_lead_r, x_lead_rr], [z_lead, z_lead_r, z_lead_rr], 2);
%         z_soh(j) = polyval(coeff, j);

        L0 = ((j-x_lead_r)*(j-x_lead_rr))/((x_lead-x_lead_r)*(x_lead-x_lead_rr))*z_lead;
        L1 = ((j-x_lead)*(j-x_lead_rr))/((x_lead_r-x_lead)*(x_lead_r-x_lead_rr))*z_lead_r;
        L2 = ((j-x_lead)*(j-x_lead_r))/((x_lead_rr-x_lead)*(x_lead_rr-x_lead_r))*z_lead_rr;
        z_soh(j) = L0+L1+L2;
    end
    dzdt(i_global)   = a.*(z_soh( (i-1)*Nh/Na+1:(i)*Nh/Na )-z(i_global));
    dzdt(x_lead)     = mu*(0-z_lead);
end

end

















